# Микросервисы

## Домашнее задание
Выделить часть функционала монолита в микросервис

**Цель:**
Подготовить документ-план распила монолита на микросервисы.

**Описание/Пошаговая инструкция выполнения домашнего задания:**

1) Выбрать крупную, известную вам информационную систему, 
в примере по ссылке https://docs.google.com/spreadsheets/d/1Y-0ExAXsmt-tyQOgjAZv43ReCvMUR5kVcpGN1ppQWGw/edit?usp=sharing представлено Яндекс.Такси. 
2) Описать ее назначение и один или несколько ее бизнес процессов
3) Определить необходимые микросервисы, и их назначение (должно быть не менее 5)
4) Описать взаимодействие сервисов в рамках одного из бизнес-сценариев. 
Т.е. какой микросервис с кем взаимодействует, какие данные передает, какие ожидает и способ взаимодействия (синхронно (какая технология?) 
или асинхронно (какая технология?)) 
Например, при запросе от пользователя нам необходимо: 
проверить не исключен ли он,
затем построить маршрут
на основе маршрута у тарификатора получить данные о стоимости
и т.д.
5) Использовать паттер strangler для одного из микросервисов

## Реализация

Для примера анализа возьмем систему технического документооборота Tdms от компании CSoft Development(https://tdms.ru/).

### Назначение Tdms

Система TDMS предназначена для управления информационными потоками и электронной документацией проектных, конструкторских, производственных организаций и любых других предприятий, в работе которых используются технические данные и создаваемые на их основе документы: чертежи, планы, схемы, спецификации, ведомости и т.п.
Основным ядром Tdms является монолитный модуль построенные по 3-х звенной архитектуре.
WebClient - Server - Db.
+ Система является конфигурируемой и расширяемой. Т.е. можно создавать доменные сущности, формы ввода и автоматизировать бизнес процессы во встроенном редакторе на языке vbs.
+ Система позволяет хранить и управлять файлами (файлы хранятся не в бд, а в дисковом хранилище), конвертировать форматы и генерировать предпросмотр.
+ Система имеет встроенную почту и чат.
+ Система имеет авторизацию и управление правами пользователей.

![Архитектура](/Architecture.png) 

Т.о. система является архитектурным прототипом для построения систем документооборота и содержит основные функции присущие таким системам и возможность расширения доменной модели для предметной области.

**Задача**

Необходимо уменьшить связность и разбить систему на микросервисы для повышения надёжности, тестируемости, отказоусойчивости, взаимозаменяемости и удобного разделения на команды при разработке.

<details>
**<summary>Микросервисы</summary>**

+ Основная доменная модель и пользовательские расширения
+ Управление пользователями
+ Почта
+ Чат
+ Хранение тел файлов
+ Генерация предпросмотра
+ Планировщик команд запускаемых по расписанию

Замечание: Доменную бизнес модель(расширяемую разработчиками конфигурации) и бизнес сервисы, предполагается оставить в одном микросервисе(в силу того, что архитектура расширяемой части имеет api и сильную связность).

**Взаимодествие выделенных микросервисов:**

![Взаимодействие микросервисов](/ServicesCooperation.png) 
</details>

### 2 базовых сценария работы с системой

**Редактирование карточки объекта**

1) Пользователь авторизуется
2) Открывает карточку объекта
3) Загружает файл в виде .doсx документа (асинхронно)
4) Видит предпросмотр в виде jpeg/pdf (асинхронно)
5) Сохраняет объект

**Создание и отправка письма**

1) Пользователь авторизуется
2) Открывает диалог редактирования письма
3) Прикрепляет объект системы в качестве вложения (синхронно)
4) Добавляет внешний файл к письму в качестве вложения (асинхронно)
3) Выбирает пользователей получателей (синхронно)
4) Добавляет в поле сc внешний email
5) Наживает отправить письмо
6) Система отправляет внутренний email пользователям системы и внешний email
через imap на внешние mail сервера (асинхронно)

### Разбиение монолита на микросервисы по паттерну Strangler

Мартина Фаулер рекомендует преобразовать монолит в модульный монолит, а затем в микросервис. 

Меньше всего взаимодействия между компонентами у модулей FileService и PreviewService(их проще выделить в микросервис), но рассмотрим выделение микросервиса на примере почты(т.к. в нашем примере она имеет наибольшее количество связей, но отдельный функционал).

**План миграции сервиса работы с почтовыми сообщениями**

1) Выделить из ORM системы все сущности, которые относятся к почте  

Классы моделей:
+ **MailMessage** - информация о письме и тело  
+ **MailFolder** - почтовая папка.  
2) Создать отдельный репозитория для работы с почтовыми сущностями
    **IMailRepository**.
3) Выделить операции отправки почты в отдельный класс сервиса
    **IMailService**.
4) Выделить отдельный сервис **IUserService**, который сможет по id пользователя получать почтовый адрес и наоборот.
5) Выделить отдельный сервис **IFileService**, который сможет сохранять и загружать тела файлов в хранилище из IStream в определенный fileId.
6) Создать отдельный проект **MailServiceModule** и перенести выделенные классы.
7) Написать unit и mock тесты, проверяющие работу доменной модели и сервисов работы с почтой.
9) Подключить модуль **MailServiceModule** как dll reference к основному проекту, переписать основной функционал для работы через выделенные сервисы **IMailRepository**, **IMailService**, **IFileService**, **IUserService**.
(модуль по прежнему работает в единой базе данных, но со своими таблицами).

![Базовый монолит](/ArchitectureStrangler.2.png) 

10) Добавить в модуль **MailServiceModule** независимый rest http controller, для создания, удаления, отправки почты, изменения структуры почтовых папок(В dto моделях rest api имеется только ограниченная информация о моделях других сервисов. Например для пользователя только id и email, а для файлов только имя и fileId хранилища тела файла).
11) Выделить в модуле **MailServiceModule** возможность работы с отдельной базой данных. Добавить миграции и конвертеры из одной базы в другую.
12) Запустить **MailServiceModule** как отдельный сервер, протестировать http и написать unit тесты контроллеров.
13) Перенаправить запросы с http api почты основного сервера на сервер **MailService**.
14) Настроить одновременное развертывание в docker/kubernates обоих серверов.

![Базовый монолит](/ArchitectureStrangler.3.png) 

15) Протестировать систему целиком интеграционными тестами.
16) Если что-то пойдет не так, откатываемся и работаем через **IMailService** из слинкованного модуля.
17) В случае успешной тестовой эксплуатации, полностью отключить и удалить прямые вызовы сервисов почты. Далее работаем только через http Api шлюз.
18) P.S. Если из основного api потребуется рассылка почты, можно отправлять её через http, либо подключить очередь сообщений и посылать команды туда. А mail сервис будет слушать и рассылать сообщения.

### Результат

В последствии, вынести **фронт**, **api gateway** на отдельный сервер, и проделать аналогичные операции для остальных модулей. Заменить часть прямых http запросов на асинхронные события и подключить **message brocker**. Получим микросервисную архитектуру

![Базовый монолит](/ArchitectureStrangler.Microservices.png) 

